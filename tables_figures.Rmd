---
title: "tables_figures"
output:
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(knitr)
library(kableExtra)
library(purrr)
library(furrr)
library(boot)
library(lme4)
library(ICC) 
library(dotwhisker)
library(broom)
library(car)
library(reshape2)
library(sjPlot)
library(readxl)
library(broom.mixed)
library(bbmle)
library(glmmTMB)
library(performance)
library(MASS)
library(mgcv)
library(gridExtra)
library(tableone)
library(corrr)
library(psych)
library(zoo)
library(flextable)

```

Annual models from DMED data.



## Load  data
```{r load_datasets, message = FALSE}

hsi_data <-
  read_rds("data/hsi_data.rds")

```


```{r}
hsi_data %>% 
  filter(index %in% c("hours_tmp_gt90", "hours_hi_gt90"))


#inspect
hsi_data %>% 
  filter(type %in% "Hospitalizations", 
         year %in% "2011",
         site_name %in% "Fort Hood") %>% 
  arrange(desc(value))

```


```{r load_datasets, message = FALSE}

# Plots of heat indices over time
hsi_data %>% 
  filter(type %in% "Hospitalizations") %>% 
  ggplot(aes(x = year, y = value, color = site_name)) +
    geom_point() +
    geom_smooth(method = lm, se = FALSE, size = 0.5) +
  facet_wrap(~index, scale = "free") + 
  theme_bw()

#ggsave("output/indices_by_site_name.png")


# Boxplots

hsi_data %>% 
  filter(type %in% "Hospitalizations") %>%
  group_by(year) %>% 
  summarise(mean_value = mean(value)) 

hsi_data %>% 
  filter(type %in% "Hospitalizations") %>%
  group_by(site_name, index) %>% 
  ggplot(aes(x = year, group = year, y = value)) +
    geom_boxplot() +
    facet_wrap(~index)
    theme_bw()


```



## Tables

```{r}

# Table 1: HSI outcomes

hsi_data %>% 
  filter(index %in% "mean_tmp") %>% 
  dplyr::select(site_name, type, year, count, rate) %>% 
  group_by(site_name, type) %>%
  summarise(mean_count = mean(count),
            sd_count = sd(count),
            mean_rate = mean(rate),
            sd_rate = sd(rate)) %>% 
  pivot_wider(names_from = type, values_from = c(mean_count:sd_rate))


# Table 2: Indices of Heat

hsi_data %>% 
  filter(type %in% "Hospitalizations") %>% 
  dplyr::select(site_name, index, year, value) %>% 
  group_by(site_name, index) %>%
  summarise(mean_value = mean(value),
            sd_value = sd(value)) %>%
  mutate(value = paste0(round(mean_value, 2)," ", "(", round(sd_value, 2), ")")) %>% 
  dplyr::select(site_name, index, value) %>% 
  pivot_wider(names_from = index, values_from = value) 



## Indices Correlation matrix
# hsi_data %>% 
#   filter(type %in% "Hospitalizations") %>% 
#   dplyr::select(site_name, index, year, value) %>% 
#   group_by(site_name, index) %>%
#   summarise(mean_value = mean(value)) %>% 
#   dplyr::select(site_name, index, mean_value) %>% 
#   pivot_wider(names_from = index, values_from = mean_value) %>% 
#   ungroup() %>% 
#   mutate(site_name = as.character(site_name)) %>% .[2:10] %>% 
#   psych::pairs.panels()

```


## Temperature over time models

```{r}

tmp_lm_function = function(df) {
  df %>%
    lm(value ~ year, data = .)
}



# Slope estimate
tmp_slopes <-
  hsi_data %>% 
    filter(type %in% "Hospitalizations") %>% 
    nest(data = -c(site_name, index)) %>% 
    mutate(lm_tmp = map(data, tmp_lm_function),
           tidy =   map(lm_tmp, broom::tidy),
           glance = map(lm_tmp, broom::glance))



# Temperature slope estimates (1991-2018)
tmp_slopes %>% 
    unnest(tidy) %>%
    dplyr::select(site_name, index, term:p.value) %>% 
    filter(term %in% "year") 

# Significant positive slopes
tmp_slopes %>% 
    unnest(tidy) %>%
    dplyr::select(site_name, index, term:p.value) %>% 
    filter(term %in% "year",
           p.value < 0.05) %>% 
    arrange(desc(estimate)) %>% as.data.frame()


tmp_slopes %>% 
    unnest(tidy) %>%
    filter(term %in% "year") %>% 
    group_by(index) %>% 
    ggplot() +
      geom_boxplot(aes(x = reorder(index, estimate), y = estimate)) +
      coord_flip()


# p-values    
hsi_data %>% 
  filter(type %in% "Hospitalizations") %>% 
  nest(data = -c(site_name, index)) %>%  
  mutate(lm_tmp = map(data, tmp_lm_function),
         tidy =   map(lm_tmp, broom::tidy),
         glance = map(lm_tmp, broom::glance)) %>% 
  unnest(tidy) %>% 
  filter(term %in% "year") %>% 
  group_by(index) %>% 
  ggplot() +
    geom_boxplot(aes(x = reorder(index, p.value), y = p.value)) +
    geom_hline(yintercept = 0.05, color = "blue") +
    coord_flip() 



  
```



## Plot HSI

```{r}
plot_amb_hsi <-
  hsi_data %>% 
    filter(type == "Ambulatory Data") %>% 
   ggplot(aes(x = year, y = rate, color = site_name)) +
      geom_point() +
      geom_line() +
      labs(
        title = "Army Ambulatory Rates - HSI",
        x = "Year",
        y = "All ICD rate (per 1,000 persons per year)"
      ) +
      theme_bw() +
      theme(strip.text = element_text(size = 6)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1))


plot_hosp_hsi <-
  hsi_data %>% 
    filter(type == "Hospitalizations") %>% 
   ggplot(aes(x = year, y = rate, color = site_name)) +
      geom_point() +
      geom_line() +
      labs(
        title = "Army Hospitalization Rates - HSI",
        x = "Year",
        y = "All ICD rate (per 1,000 persons per year)"
      ) +
      theme_bw() +
      theme(strip.text = element_text(size = 6)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1))



plot_rme_hsi <-
  hsi_data %>% 
    filter(type == "Reportable Events") %>% 
   ggplot(aes(x = year, y = rate, color = site_name)) +
      geom_point() +
      geom_line() +
      labs(
        title = "Army Reportable Event Rates - HSI",
        x = "Year",
        y = "All ICD rate (per 1,000 persons per year)"
      ) +
      theme_bw() +
      theme(strip.text = element_text(size = 6)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1))

gridExtra::grid.arrange(plot_amb_hsi, plot_hosp_hsi, plot_rme_hsi, nrow = 1)




# Facet wrap

# HSI
 hsi_data %>% 
   ggplot(aes(x = year, y = rate, color = site_name)) +
      geom_point() +
      geom_line() +
      labs(
        title = "Heat Stress Illness Rates",
        x = "Year",
        y = "HSI rate (per 1,000 persons per year)"
      ) +
      facet_grid(~type) +
      theme_bw() +
      theme(strip.text = element_text(size = 6)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1))

# All ICD
 hsi_data %>% 
   ggplot(aes(x = year, y = rate_overall, color = site_name)) +
      geom_point() +
      geom_line() +
      labs(
        title = "All-ICD Code Rates",
        x = "Year",
        y = "All-ICD rate (per 1,000 persons per year)"
      ) +
      facet_grid(~type) +
      theme_bw() +
      theme(strip.text = element_text(size = 6)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

## By site_name Tables


```{r}

#indices

wider_fun = function(df) {
  pivot_wider(df, names_from = year, values_from = value)
}



# get group keys
group_name <- hsi_data %>% 
  group_keys(site_name) %>% 
  .$site_name


index_tables <-    
  hsi_data %>%
    filter(type %in% "Hospitalizations",
           year >= 2008) %>%
    mutate(value = format(round(value, 2), nsmall = 2)) %>% 
    dplyr::select(site_name, index, year, value) %>%
    group_split(site_name, keep = FALSE) %>%
    purrr::map(wider_fun) %>% 
    setNames(group_name)



index_tables[[1]] %>% 
  flextable() %>% 
  flextable::fontsize(., part = "all", size = 6) %>% 
  flextable::padding(., padding = 0, part = "body") %>%
  flextable::bold(., part = "header") %>% 
  flextable::autofit() %>% 
  print(., preview = "docx")



```




```{r}
# Variability over time 
# hsi_data %>% 
#   filter(index %in% "tmp_f_sd",
#          type %in% "Hospitalizations") %>% 
#    ggplot(aes(x = year, y = value, color = site_name)) +
#       geom_point() +
#       geom_line() +
#       labs(
#         title = "Temperature SD",
#         x = "Year",
#         y = "SD, Temp (°F)"
#       ) +
#       facet_grid(~type) +
#       theme_bw() +
#       theme(axis.text.x = element_text(angle = 90, hjust = 1))
#   
# hsi_data %>% 
#   filter(index %in% "heat_index_sd",
#          type %in% "Hospitalizations") %>% 
#    ggplot(aes(x = year, y = value, color = site_name)) +
#       geom_point() +
#       geom_line() +
#       labs(
#         title = "Temperature SD",
#         x = "Year",
#         y = "SD, Temp (°F)"
#       ) +
#       facet_grid(~type) +
#       theme_bw() +
#       theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

