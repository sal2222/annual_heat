---
title: "model_assess"
output:
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(knitr)
library(kableExtra)
library(magick)
library(purrr)
library(furrr)
library(boot)
library(lme4)
library(ICC) 
library(dotwhisker)
library(broom)
library(car)
library(reshape2)
library(sjPlot)
library(readxl)
library(broom.mixed)
library(bbmle)
library(glmmTMB)
library(performance)
library(MASS)
library(mgcv)
library(grid)
library(gridExtra)
library(tableone)
library(corrr)
library(psych)
library(zoo)
library(patchwork) # install_github("thomasp85/patchwork")
library(vcd)
library(table1)

```

#Model Tables and Figures


## Load data
```{r load_datasets, message = FALSE}

hsi_data <-
  read_rds("data/hsi_data.rds")

summary(hsi_data)

## Models

amb_nb <-
  read_rds("data/amb_nb.rds") 

hosp_nb <-
  read_rds("data/hosp_nb.rds") 

rme_nb <-
  read_rds("data/rme_nb.rds") 

amb_boot_2yr_block <-
  read_rds("data/amb_boot_2yr_block.rds") 

hosp_boot_2yr_block <-
  read_rds("data/hosp_boot_2yr_block.rds") 

rme_boot_2yr_block <-
  read_rds("data/rme_boot_2yr_block.rds") 

amb_boot_3yr_block <-
  read_rds("data/amb_boot_3yr_block.rds") 


hosp_boot_3yr_block <-
  read_rds("data/hosp_boot_3yr_block.rds") 

rme_boot_3yr_block <-
  read_rds("data/rme_boot_3yr_block.rds") 

amb_boot_std <-
  read_rds("data/amb_boot_std.rds") 

hosp_boot_std <-
  read_rds("data/hosp_boot_std.rds") 

rme_boot_std <-
  read_rds("data/rme_boot_std.rds") 



```


## Model data transform - long

```{r }

## Combined panel RR plot

amb_boot2_long <-
  amb_boot_2yr_block %>%
    unnest(tidy) %>% 
    filter(term %in% "value") %>% 
    dplyr::select(index, statistic, bias, conf.low, conf.high) %>% 
    pivot_longer(cols = -index,
                 names_to = "term",
                 values_to = "value") %>% 
    mutate(outcome = "Ambulatory")
  
  
hosp_boot2_long <-
  hosp_boot_2yr_block %>%
    unnest(tidy) %>% 
    filter(term %in% "value") %>% 
    dplyr::select(index, statistic, bias, conf.low, conf.high) %>% 
    pivot_longer(cols = -index,
                 names_to = "term",
                 values_to = "value") %>% 
    mutate(outcome = "Hospitalizations")  


rme_boot2_long <-
  rme_boot_2yr_block %>%
    unnest(tidy) %>% 
    filter(term %in% "value") %>% 
    dplyr::select(index, statistic, bias, conf.low, conf.high) %>% 
    pivot_longer(cols = -index,
                 names_to = "term",
                 values_to = "value") %>% 
    mutate(outcome = "Reportable Events")  


# Join dataframes

boot2_long <-
  amb_boot2_long %>% 
    bind_rows(hosp_boot2_long) %>% 
    bind_rows(rme_boot2_long)

# write_rds(boot2_long, file = "data/boot2_long.rds")

boot2_long <-
  read_rds(path = "data/boot2_long.rds")
```





## IRR of two-year block bootstrap negative binomial models (Figure 2)
Select indices, 10,000 bootstrap iterations

RRs for active-duty HSI encounters at 10 CONUS U.S. Army installations per 1° increase in annual index of heat from 2-year block bootstrap negative binomial models with basic (empirical) confidence intervals based on 10,000 replicates, controlling for installation-level effects and long-term time trends. Temperature, HI, and WBGT categories reflect annual mean values in °F. Solid points reflect the mean of bootstrap estimates and non-filed points reflect the original sample (non-bootstrap) estimate. 

```{r}


full_year <-
  amb_boot_2yr_block %>% 
    unnest(tidy) %>%
    mutate(type = "Ambulatory") %>% 
    dplyr::select(-amb_data) %>% 
    bind_rows(
  hosp_boot_2yr_block %>% 
    unnest(tidy) %>%
    mutate(type = "Hospitalizations") %>% 
    dplyr::select(-hosp_data)
  ) %>% bind_rows(
  rme_boot_2yr_block %>% 
    unnest(tidy) %>%
    mutate(type = "Reportable Events") %>% 
    dplyr::select(-re_data)) %>% 
  filter(index %in% c("mean_tmp", "mean_hi","mean_wbgt")) %>% 
    mutate(avg_period = "Full year") %>% 
    dplyr::select(-boot) %>% 
    filter(term %in% "value") %>%
    mutate(index = fct_relevel(index, c("mean_wbgt", "mean_hi")),  # orders from bottom to top
           #index = forcats::fct_reorder(index, desc(statistic - bias )) # order index by bootstrap mean (statistic - bias) for plot appearance
           index = dplyr::recode(index,
                                `mean_tmp` = "Temperature (°F)",
                                `mean_hi` = "Heat Index (°F)",
                                `mean_wbgt` = "WBGT (°F)"))
  
heat_season <-
  amb_boot_2yr_block %>% 
    unnest(tidy) %>%
    mutate(type = "Ambulatory",
           avg_period = "May-Sep") %>% 
    dplyr::select(-amb_data) %>% 
  bind_rows(
    hosp_boot_2yr_block %>% 
    unnest(tidy) %>%
    mutate(type = "Hospitalizations",
           avg_period = "May-Sep") %>% 
    dplyr::select(-hosp_data)
  ) %>% bind_rows(
  rme_boot_2yr_block %>% 
    unnest(tidy) %>%
    mutate(type = "Reportable Events",
           avg_period = "May-Sep") %>% 
    dplyr::select(-re_data)
  ) %>%
  filter(index %in% c("mean_tmp_may_sep", "mean_hi_may_sep","mean_wbgt_may_sep")) %>% 
  dplyr::select(-boot) %>% 
    filter(term %in% "value") %>%
    mutate(index = fct_relevel(index, c("mean_wbgt", "mean_hi")),  # orders from bottom to top
           #index = forcats::fct_reorder(index, desc(statistic - bias )) # order index by bootstrap mean (statistic - bias) for plot appearance
           index = dplyr::recode(index,
                                `mean_tmp_may_sep` = "Temperature (°F)",
                                `mean_hi_may_sep` = "Heat Index (°F)",
                                `mean_wbgt_may_sep` = "WBGT (°F)")
                            ) 


full_year %>%
  bind_rows(heat_season) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index), shape = 1, fill = "white", color = "green4", size = 3.25) +
        geom_point(aes(x = exp(statistic - bias), y = index), size = 3.25) +
        geom_text(aes(x = exp(statistic - bias), y = index, 
                      label = round(exp(statistic - bias), 2)), 
                      hjust = 0.5, vjust = 2, size = 3) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high)), 
          size = 1.03, height = 0.2) +
         geom_vline(aes(xintercept = 1), colour = "blue", linetype = "dashed") +
         facet_grid(vars(avg_period), vars(type)) +
         theme_bw() +
         theme(#axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         xlab("Rate Ratio") +
#  ggtitle("Rate ratios for full-year and heat season indices of heat and HSI encounters\nat 10 CONUS U.S. Army installations") + 
#  labs(caption = "RRs per 1 degree increase in annual index of heat (mean of daily means) from 2-year block bootstrap negative binomial models\nwith basic (empirical) confidence intervals based on 10,000 replicates, controlling for installation-level effects.\nSolid points reflect the mean of bootstrap estimates and unfilled points reflect the original sample (non-bootstrap) estimate.") +
   theme(plot.caption = element_text(hjust = 0, size = 9)) 


# ggsave(filename = "figure2_rev.tiff", path = "output")


```


## Grouped IRRs
## IRRs of temperature-based indices


```{r}

joined_boot_2yr <-
  amb_boot_2yr_block %>% 
      unnest(tidy) %>%
      mutate(type = "Ambulatory") %>% 
      dplyr::select(-amb_data) %>% 
      bind_rows(
    hosp_boot_2yr_block %>% 
      unnest(tidy) %>%
      mutate(type = "Hospitalizations") %>% 
      dplyr::select(-hosp_data)
    ) %>% bind_rows(
    rme_boot_2yr_block %>% 
      unnest(tidy) %>%
      mutate(type = "Reportable Events") %>% 
      dplyr::select(-re_data)) %>% 
    filter(term %in% "value") %>% 
    dplyr::select(-c(boot, tidy_bca)) %>% 
  mutate(cat = case_when(str_detect(index, "hour")  ~ "Hours",
                         str_detect(index, "day")  ~ "Days",
                         str_detect(index, "anom")  ~ "Anomaly",
                         str_detect(index, "mean")  ~ "Mean",
                         str_detect(index, "max")  ~ "Maximum"),
         season = case_when(str_detect(index, "may")  ~ "Heat Season",
                            TRUE ~ "Full Year"),
         index_scale = case_when(str_detect(index, "tmp")  ~ "Temperature",
                                 str_detect(index, "hi")  ~ "Heat Index",
                                 str_detect(index, "wbgt")  ~ "WBGT"),
         index_name = dplyr::recode(index, mean_tmp = "Mean Tmp",
                          mean_hi = "Mean HI",
                          mean_wbgt = "Mean WBGT",
                          max_tmp = "Max Tmp",
                          max_hi = "Max HI",
                          max_wbgt = "Max WBGT",
                          mean_tmp_may_sep = "Mean Tmp HS",
                          mean_hi_may_sep = "Mean HI HS",
                          mean_wbgt_may_sep = "Mean WBGT HS",
                          max_tmp_may_sep = "Max Tmp HS",
                          max_hi_may_sep = "Max HI HS",
                          max_wbgt_may_sep = "Max WBGT HS",
                          hours_tmp_gt90 = "Hrs Tmp > 90",
                          hours_tmp_gt100 = "Hrs Tmp > 100",
                          hours_hi_gt90 = "Hrs HI > 90",
                          hours_hi_gt105 = "Hrs HI > 105",
                          hours_wbgt_gt85 = "Hrs WBGT > 85",
                          hours_wbgt_gt90 = "Hrs WBGT > 90",
                          tmp_anomaly = "Tmp Anomaly",
                          hi_anomaly = "HI Anomaly",
                          wbgt_anomaly = "WBGT Anomaly",
                          days_tmp_gt1sd = "Days Tmp > 1 SD",
                          days_hi_gt1sd = "Days HI > 1 SD",
                          days_wbgt_gt1sd = "Days WBGT > 1 SD",
                          tmp_anomaly_may_sep = "Tmp Anomaly HS",
                          hi_anomaly_may_sep = "HI Anomaly HS",
                          wbgt_anomaly_may_sep = "WBGT Anomaly HS",
                          days_tmp_gt1sd_may_sep = "Days Tmp > 1 SD HS",
                          days_hi_gt1sd_may_sep = "Days HI > 1 SD HS",
                          days_wbgt_gt1sd_may_sep = "Days WBGT > 1 SD HS"),
         index_scale = fct_relevel(index_scale, c("Temperature", "Heat Index", "WBGT")),
         season = fct_relevel(season, c( "Full Year", "Heat Season")),
         cat = fct_relevel(cat, c("Mean", "Maximum", "Anomaly", "Hours")))
                                 

joined_boot_2yr
# write_rds(joined_boot_2yr, file = "data/joined_boot_2yr.rds")

joined_boot_2yr <-
  read_rds(file = "data/joined_boot_2yr.rds")

```



```{r}


joined_boot_2yr %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index_name), shape = 1, fill = "white", color = "green4", size = 3.25) +
        geom_point(aes(x = exp(statistic - bias), y = index_name), size = 3.25) +
        geom_text(aes(x = exp(statistic - bias), y = index_name, 
                      label = round(exp(statistic - bias), 2)), 
                      hjust = 0.5, vjust = 2, size = 3) +
        geom_errorbarh(
          aes(y = index_name,
              xmin = exp(conf.low),
              xmax = exp(conf.high)), 
          size = 1.03, height = 0.2) +
         geom_vline(aes(xintercept = 1), colour = "blue", linetype = "dashed") +
         facet_grid(cat + season ~ type, scales = "free", drop = TRUE) +
         theme_bw() +
         theme(#axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         xlab("Rate Ratio") +
   theme(plot.caption = element_text(hjust = 0, size = 9)) 



#  ggtitle("Rate ratios for full-year and heat season indices of heat and HSI encounters\nat 10 CONUS U.S. Army installations") + 
#  labs(caption = "RRs per 1 degree increase in annual index of heat (mean of daily means) from 2-year block bootstrap negative binomial models\nwith basic (empirical) confidence intervals based on 10,000 replicates, controlling for installation-level effects.\nSolid points reflect the mean of bootstrap estimates and unfilled points reflect the original sample (non-bootstrap) estimate.") +


```

### Hours (per 10 hour increment)
```{r}

joined_boot_2yr %>%
  filter(cat %in% "Hours") %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index_name), shape = 1, fill = "white", color = "green4", size = 3.25) +
        geom_point(aes(x = exp(statistic - bias), y = index_name), size = 3.25) +
        geom_text(aes(x = exp(statistic - bias), y = index_name, 
                      label = round(exp(statistic - bias), 2)), 
                      hjust = 0.5, vjust = 2, size = 3) +
        geom_errorbarh(
          aes(y = index_name,
              xmin = exp(conf.low),
              xmax = exp(conf.high)), 
          size = 1.03, height = 0.2) +
         geom_vline(aes(xintercept = 1), colour = "blue", linetype = "dashed") +
         facet_grid(season + index_scale ~ type, scales = "free", drop = TRUE) +
         theme_bw() +
         theme(#axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         xlab("Rate Ratio") +
   theme(plot.caption = element_text(hjust = 0, size = 9)) 

# ggsave(filename = "hours_rr_rev.tiff", path = "output")

```


## Days

```{r}

joined_boot_2yr %>%
  filter(cat %in% "Days") %>% 
   mutate(index_name = fct_relevel(index_name, c("Days WBGT > 1 SD", "Days HI > 1 SD", "Days Tmp > 1 SD", 
                                                 "Days WBGT > 1 SD HS", "Days HI > 1 SD HS", "Days Tmp > 1 SD HS"))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index_name), shape = 1, fill = "white", color = "green4", size = 3.25) +
        geom_point(aes(x = exp(statistic - bias), y = index_name), size = 3.25) +
        geom_text(aes(x = exp(statistic - bias), y = index_name, 
                      label = round(exp(statistic - bias), 2)), 
                      hjust = 0.5, vjust = 2, size = 3) +
        geom_errorbarh(
          aes(y = index_name,
              xmin = exp(conf.low),
              xmax = exp(conf.high)), 
          size = 1.03, height = 0.2) +
         geom_vline(aes(xintercept = 1), colour = "blue", linetype = "dashed") +
         facet_grid(season ~ type, scales = "free", drop = TRUE) +
         theme_bw() +
         theme(#axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         xlab("Rate Ratio") +
   theme(plot.caption = element_text(hjust = 0, size = 9))

# ggsave(filename = "days_rr_rev.tiff", path = "output")

```


### Degree Indices
```{r}

joined_boot_2yr %>%
  filter(cat %in% c("Mean", "Maximum", "Anomaly")) %>% 
   mutate(index_name = fct_relevel(index_name, c("WBGT Anomaly HS", "HI Anomaly HS", "Tmp Anomaly HS",
                                                 "WBGT Anomaly", "HI Anomaly", "Tmp Anomaly",
                                                 "Max WBGT HS", "Max HI HS", "Max Tmp HS",
                                                 "Max WBGT", "Max HI", "Max Tmp",
                                                 "Mean WBGT HS", "Mean HI HS", "Mean Tmp HS",
                                                 "Mean WBGT", "Mean HI", "Mean Tmp"))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index_name), shape = 1, fill = "white", color = "green4", size = 3.25) +
        geom_point(aes(x = exp(statistic - bias), y = index_name), size = 3.25) +
        geom_text(aes(x = exp(statistic - bias), y = index_name, 
                      label = round(exp(statistic - bias), 2)), 
                      hjust = 0.5, vjust = 1.75, size = 2) +
        geom_errorbarh(
          aes(y = index_name,
              xmin = exp(conf.low),
              xmax = exp(conf.high)), 
          size = 1.03, height = 0.2) +
         geom_vline(aes(xintercept = 1), colour = "blue", linetype = "dashed") +
         facet_grid(season + cat ~ type, scales = "free", drop = TRUE) +
         theme_bw() +
         theme(#axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         xlab("Rate Ratio") +
   theme(plot.caption = element_text(hjust = 0, size = 9))
```


amb_boot_2yr_block %>% 
  unnest(tidy) %>%
  mutate(type = "AMBULATORY") %>% 
  dplyr::select(-amb_data) %>% 
  bind_rows(
hosp_boot_2yr_block_all %>% 
  unnest(tidy) %>%
  mutate(type = "HOSPITALIZATIONS") %>% 
  dplyr::select(-hosp_data)
) %>% bind_rows(
rme_boot_2yr_block_all %>% 
  unnest(tidy) %>%
  mutate(type = "REPORTABLE EVENTS") %>% 
  dplyr::select(-rme_data)
) %>%
  dplyr::select(index, term:type) %>% 
  filter(term %in% "value",
         !index %in% c("tmp_f_mean", "wbgt_f_mean", "heat_index_mean",
                       "tmp_mean_may_sep", "wbgt_f_mean_may_sep", "heat_index_mean_may_sep",
                       "tmp_f_sd", "wbgt_f_sd", "heat_index_sd",
                       "tmp_f_min", "heat_index_min", "wbgt_f_min"),
         !str_detect(index, "hour"),
         !str_detect(index, "day")) %>% 
  mutate(index = dplyr::recode(index, `tmp_max_may_sep` = "tmp_f_max_may_sep"),
         timeframe = case_when(!str_detect(index, "may") ~ "FULL YEAR",
                               str_detect(index, "may")   ~ "MAY-SEP"),  # create column for `full year` or `heat season`
         index = case_when(!str_detect(index, "may") ~ as.character(index),
                           str_detect(index, "may") ~ as.character(str_remove(index, "_may_sep"))),  # remove `_may_sep` suffix
         index = forcats::fct_reorder(index, statistic - bias) # order index by bootstrap mean (statistic - bias) for plot appearance
                           ) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index), shape = 1, fill = "white", color = "black", size = 1) +
        geom_point(aes(x = exp(statistic - bias), y = index), size = 1) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         facet_grid(vars(timeframe), vars(type)) +
         theme_bw() +
         theme(#axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         xlab("Rate Ratio") 


ggsave(filename = "2yr_degree_all_plot.png", path = "output", width = 8, height = 5)


```


## IRRs of day/hour-based indices (Figure 4)


```{r}

# Day-based indices

plot_day_indices <-
  amb_boot_2yr_block_all %>% 
    unnest(tidy) %>%
    mutate(type = "AMBULATORY") %>% 
    dplyr::select(-amb_data) %>% 
    bind_rows(
  hosp_boot_2yr_block_all %>% 
    unnest(tidy) %>%
    mutate(type = "HOSPITALIZATIONS") %>% 
    dplyr::select(-hosp_data)
  ) %>% bind_rows(
  rme_boot_2yr_block_all %>% 
    unnest(tidy) %>%
    mutate(type = "REPORTABLE EVENTS") %>% 
    dplyr::select(-rme_data)
  ) %>% bind_rows(
  amb_boot_2yr_block_addl %>% 
    unnest(tidy) %>%
    mutate(type = "AMBULATORY") %>% 
    dplyr::select(-amb_data) 
  ) %>% bind_rows(
  hosp_boot_2yr_block_addl %>% 
    unnest(tidy) %>%
    mutate(type = "HOSPITALIZATIONS") %>% 
    dplyr::select(-hosp_data)
  ) %>% bind_rows(
  rme_boot_2yr_block_addl %>% 
    unnest(tidy) %>%
    mutate(type = "REPORTABLE EVENTS") %>% 
    dplyr::select(-rme_data)
  ) %>%
  dplyr::select(index, term:type) %>% 
  filter(term %in% "value",
         str_detect(index, "day") # filter all indices with `day` in name 
      ) %>% 
  mutate(statistic = case_when(str_detect(index, "hour")  ~ statistic * 24,
                        TRUE ~ statistic),
         bias = case_when(str_detect(index, "hour")  ~ bias * 24,
                        TRUE ~ bias),
         std.error = case_when(str_detect(index, "hour")  ~ std.error * 24,
                        TRUE ~ std.error),
         conf.low = case_when(str_detect(index, "hour")  ~ conf.low * 24,
                        TRUE ~ conf.low),
         conf.high = case_when(str_detect(index, "hour")  ~ conf.high * 24,
                        TRUE ~ conf.high),
      #index = dplyr::recode(index, `tmp_max_may_sep` = "tmp_f_max_may_sep"),
         timeframe = case_when(!str_detect(index, "may") ~ "FULL YEAR",
                               str_detect(index, "may")   ~ "MAY-SEP"),  # create column for `full year` or `heat season`
         index = case_when(!str_detect(index, "may") ~ as.character(index),
                           str_detect(index, "may") ~ as.character(str_remove(index, "_may_sep"))),  # remove `_may_sep` suffix
         index = forcats::fct_reorder(index, statistic - bias) # order index by bootstrap mean (statistic - bias) for plot appearance
                           ) %>%
  filter(!index %in% c("days_wbgt_gt95pct",
                       "days_wbgt_max_gt1sd",
                       "days_heat_index_max_gt1sd",
                       "days_hi_gt90",
                       "days_tmp_max_gt95pct",
                       "days_heat_index_gt85pct",
                       "days_tmp_max_gt85pct",
                       "days_heat_index_gt85pct",
                       "days_tmp_max_gt2sd",
                       "days_hi_gt80",
                       "days_tmp_max_gt90pct",
                       "days_tmp_max_gt1sd",
                       "days_heat_index_max_gt85pct",
                       "days_heat_index_max_gt90pct",
                       "days_wbgt_gt85",
                       "days_hi_gt103",
                       "days_heat_index_max_gt95pct")) %>%     # filter selection of "null" indices, tight CIs at RR 1.0
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index), shape = 1, fill = "white", color = "black", size = 1) +
        geom_point(aes(x = exp(statistic - bias), y = index), size = 1) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         facet_grid(vars(timeframe), vars(type)) +
         theme_bw() +
         theme(#axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         xlab("Rate Ratio") 




# Hour-based indices

plot_hour_indices <-
  amb_boot_2yr_block_all %>% 
    unnest(tidy) %>%
    mutate(type = "AMBULATORY") %>% 
    dplyr::select(-amb_data) %>% 
    bind_rows(
  hosp_boot_2yr_block_all %>% 
    unnest(tidy) %>%
    mutate(type = "HOSPITALIZATIONS") %>% 
    dplyr::select(-hosp_data)
  ) %>% bind_rows(
  rme_boot_2yr_block_all %>% 
    unnest(tidy) %>%
    mutate(type = "REPORTABLE EVENTS") %>% 
    dplyr::select(-rme_data)
  ) %>% bind_rows(
  amb_boot_2yr_block_addl %>% 
    unnest(tidy) %>%
    mutate(type = "AMBULATORY") %>% 
    dplyr::select(-amb_data) 
  ) %>% bind_rows(
  hosp_boot_2yr_block_addl %>% 
    unnest(tidy) %>%
    mutate(type = "HOSPITALIZATIONS") %>% 
    dplyr::select(-hosp_data)
  ) %>% bind_rows(
  rme_boot_2yr_block_addl %>% 
    unnest(tidy) %>%
    mutate(type = "REPORTABLE EVENTS") %>% 
    dplyr::select(-rme_data)
  ) %>%
  dplyr::select(index, term:type) %>% 
  filter(term %in% "value",
         str_detect(index, "hour")) %>% # filter all indices with `hour` or `day` in name 
  mutate(statistic = case_when(str_detect(index, "hour")  ~ statistic * 24,
                        TRUE ~ statistic),
         bias = case_when(str_detect(index, "hour")  ~ bias * 24,
                        TRUE ~ bias),
         std.error = case_when(str_detect(index, "hour")  ~ std.error * 24,
                        TRUE ~ std.error),
         conf.low = case_when(str_detect(index, "hour")  ~ conf.low * 24,
                        TRUE ~ conf.low),
         conf.high = case_when(str_detect(index, "hour")  ~ conf.high * 24,
                        TRUE ~ conf.high),
      #index = dplyr::recode(index, `tmp_max_may_sep` = "tmp_f_max_may_sep"),
         timeframe = case_when(!str_detect(index, "may") ~ "FULL YEAR",
                               str_detect(index, "may")   ~ "MAY-SEP"),  # create column for `full year` or `heat season`
         index = case_when(!str_detect(index, "may") ~ as.character(index),
                           str_detect(index, "may") ~ as.character(str_remove(index, "_may_sep"))),  # remove `_may_sep` suffix
         index = forcats::fct_reorder(index, statistic - bias) # order index by bootstrap mean (statistic - bias) for plot appearance
                           ) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index), shape = 1, fill = "white", color = "black", size = 1) +
        geom_point(aes(x = exp(statistic - bias), y = index), size = 1) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         facet_grid(vars(timeframe), vars(type)) +
         theme_bw() +
         theme(#axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         xlab("Rate Ratio") 
  
```







## Full Index RR Plot - Facet
boot2_long %>% 
  pivot_wider(names_from = term, 
              values_from = value) %>%
  mutate(index = fct_reorder(index, exp(statistic))) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         facet_wrap(~outcome) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
          ggtitle("HSI Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")


#ggsave("output/boot2_all.png", width = 7.5, height = 22)
  
  
##  Index RR Plot - Facet

  

boot2_long %>% 
  pivot_wider(names_from = term, 
              values_from = value) %>%
  filter(index %in% c("mean_tmp", "mean_hi","mean_wbgt", 
                          "mean_tmp_may_sep", "mean_hi_may_sep", "mean_wbgt_may_sep")) %>% 
  mutate(index = fct_reorder(index, exp(statistic))) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         facet_wrap(~outcome) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
          ggtitle("HSI Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")


#ggsave("boot2_reduced.png", width = 7.5, height = 9)





# Divide by degree units and days/hours

# Modify units: multiply hours by 24

# Degree indices
boot2_long %>% 
  pivot_wider(names_from = term, 
              values_from = value) %>%
  filter(!index %in% c("tmp_f_mean", "wbgt_f_mean", "heat_index_mean",
                       "tmp_f_mean_may_sep", "wbgt_f_mean_may_sep", "heat_index_mean_may_sep",
                       "tmp_f_sd", "wbgt_f_sd", "heat_index_sd",
                       "tmp_f_min", "heat_index_min", "wbgt_f_min"),
         !str_detect(index, "hour"),
         !str_detect(index, "day")) %>% 
  mutate(index = fct_reorder(index, exp(statistic))) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         #coord_cartesian(xlim = c(0.75, 2)) +
         facet_wrap(~outcome) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
          #ggtitle("HSI Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")

#ggsave("boot2_degrees.png", width = 8, height = 5)

# Days/hour indices


boot2_long %>%
  mutate(value = case_when(str_detect(index, "hour")  ~ value * 24,
                        TRUE ~ value)) %>% 
  pivot_wider(names_from = term, 
              values_from = value) %>%
  filter(!index %in% c("tmp_f_mean", "wbgt_f_mean", "heat_index_mean",
                       "tmp_f_mean_may_sep", "wbgt_f_mean_may_sep", "heat_index_mean_may_sep",
                       "tmp_f_sd", "wbgt_f_sd", "heat_index_sd",
                       "tmp_f_min", "heat_index_min", "wbgt_f_min"),
                        str_detect(index, "hour|day")) %>% 
  mutate(index = fct_reorder(index, exp(statistic))) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
       #  coord_cartesian(xlim = c(0.75, 2.0)) +
         facet_wrap(~outcome) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
          #ggtitle("HSI Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")


#ggsave("boot2_days.png", width = 8, height = 5)


# Slice top 20 ambulatory statistic

# vector of top 20 ambulatory indices
amb_top20_boot2_days <-
  boot2_long %>%
    mutate(value = case_when(str_detect(index, "hour")  ~ value * 24,
                          TRUE ~ value)) %>% 
    pivot_wider(names_from = term, 
                values_from = value) %>%
    filter(!index %in% c("tmp_f_mean", "wbgt_f_mean", "heat_index_mean",
                         "tmp_f_mean_may_sep", "wbgt_f_mean_may_sep", "heat_index_mean_may_sep",
                         "tmp_f_sd", "wbgt_f_sd", "heat_index_sd",
                         "tmp_f_min", "heat_index_min", "wbgt_f_min"),
                          str_detect(index, "hour|day"),
           outcome %in% "Ambulatory") %>% 
    dplyr::arrange(desc(statistic)) %>% 
    dplyr::slice(1:20) %>% 
    dplyr::select(index)


boot2_long %>%
  mutate(value = case_when(str_detect(index, "hour")  ~ value * 24,
                        TRUE ~ value)) %>% 
  pivot_wider(names_from = term, 
              values_from = value) %>%
  dplyr::semi_join(amb_top20_boot2_days, by = "index") %>% 
  mutate(index = fct_reorder(index, exp(statistic))) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         facet_wrap(~outcome) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
          #ggtitle("HSI Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")


#ggsave("boot2_days.png", width = 8, height = 5)





boot2_long %>% 
  mutate(value = case_when(str_detect(index, "hour")  ~ value * 24,
                        TRUE ~ value)) %>% 
  pivot_wider(names_from = term, 
              values_from = value) %>%
  filter(!index %in% c("tmp_f_mean", "wbgt_f_mean", "heat_index_mean",
                       "tmp_f_sd", "wbgt_f_sd", "heat_index_sd",
                       "tmp_f_min", "heat_index_min", "wbgt_f_min")) %>% 
  mutate(index = fct_reorder(index, exp(statistic))) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         facet_wrap(~outcome) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
          ggtitle("HSI Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")








# RR Table
amb_boot_2yr_block_all %>% 
  unnest(tidy) %>%
      filter(term %in% "value") %>% 
  dplyr::select(index, statistic, bias, conf.low, conf.high) %>% 
  mutate(rr = exp(statistic),
         rr_low = exp(conf.low),
         rr_high = exp(conf.high),
         rate_ratio = paste0(round(rr, 2), " (", round(rr_low, 2), ", ", round(rr_high, 2), ")")) %>% 
  dplyr::select(index, rate_ratio) %>% 
  as.data.frame() %>% print()


```


## Positive and Negative Association RR Tables

```{r}

# All index - outcome pairs

full_irr_table <-
  boot2_long %>% 
   mutate(association = paste(index, "-", outcome)) %>%
    pivot_wider(names_from = term, values_from = value) %>% 
    mutate(mean_boot_est = statistic - bias,
           rr = exp(mean_boot_est),
           rr_low = exp(conf.low),
           rr_high = exp(conf.high),
           rate_ratio = paste0(format(round(rr, digits = 2), nsmall = 2), " (", format(round(rr_low, digits = 2), nsmall = 2), ", ", format(round(rr_high, digits = 2), nsmall = 2), ")")) 

#write_rds(full_irr_table, "data/full_irr_table.rds")


full_irr_table %>% 
  dplyr::select(index, outcome, statistic, mean_boot_est, conf.low, conf.high, rate_ratio) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  kableExtra::kbl(caption = "2-Year Bootstrap Models, 2,000 replications, basic 95% CIs") %>% 
  kable_classic(full_width = FALSE) %>% 
  save_kable("output/full_irr_table.pdf")








# As single dataframe with column for association clasification
  # define whether RR is positive, negative, or null
  # classify by timeframe: full-year/heat season
  # classify by exposure measure: days/hours/degrees 
  # classify by index type: temp/HI/WBGT
  # classify as anomaly-based: anomaly/non-anomaly 

boot2_results <-
  boot2_long %>%
     mutate(association = paste(index, "-", outcome)) %>%
      pivot_wider(names_from = term, values_from = value) %>% 
      mutate(mean_boot_est = statistic - bias,
             rr = exp(mean_boot_est),
             rr_low = exp(conf.low),
             rr_high = exp(conf.high),
             rate_ratio = paste0(format(round(rr, digits = 2), nsmall = 2), " (", format(round(rr_low, digits = 2), nsmall = 2), ", ", format(round(rr_high, digits = 2), nsmall = 2), ")")) %>% 
    mutate(ci_range = case_when(
        rr_low > 1 ~ "positive",
        rr_high < 1 ~ "negative",
        TRUE ~ "null"
      ),
      exp_measure = case_when(
        str_detect(index, "day") ~ "Day",
        str_detect(index, "hour") ~ "Hour",
        TRUE ~ "Deg"
      ),
      
      anomaly = case_when(
        str_detect(index, "anom|pct|sd") ~ "Anomaly",
        TRUE ~ "Non-Anomaly"
      ),
      index_type = case_when(
        str_detect(index, "temp|tmp") ~ "T",
        str_detect(index, "heat_index|hi") ~ "HI",
        str_detect(index, "wbgt") ~ "WBGT",
        TRUE ~ "not classified"
      ),
      timeframe = case_when(
        str_detect(index, "may") ~ "May-Sep",
        TRUE ~ "Full Yr"
      )
             ) 


#write_rds(boot2_results, "data/boot2_results.rds")

boot2_results <-
  read_rds("data/boot2_results.rds")



# Overview Table

  boot2_results %>% 
    dplyr::select(outcome, exp_measure, anomaly, index_type, timeframe, ci_range) %>% 
    mutate_all(as_factor) %>% 
    table1::table1(~ outcome + index_type + timeframe + exp_measure + anomaly | ci_range, data = ., overall = "Total", row_wise = TRUE)

  
  boot2_results %>% 
    dplyr::select(outcome, exp_measure, anomaly, index_type, timeframe, ci_range) %>% 
    mutate_all(as_factor) %>% 
    table1::table1(~ ci_range | outcome + index_type , data = ., overall = "Total")
  


```




# Sensitivity analysis plots

```{r}

a1 <-
amb_boot_2yr_block %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Ambulatory \n 2 year block") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

a2 <-
amb_boot_2yr_block %>% 
    unnest(tidy_bca) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Ambulatory \n 2 year block - Bca CIs") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

a3 <-
amb_boot_3yr_block %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Ambulatory \n 3 year block") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))


a4 <-
amb_boot_std %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Ambulatory \n standard bootstrap") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

a5 <-
amb_nb %>% 
    unnest(nb_tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(estimate))) %>% 
   ggplot() +
        geom_point(aes(x = exp(estimate), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Ambulatory \n neg bin - no year term, no bootstrap") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

a6 <-
amb_nb %>% 
    unnest(nb_year_tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(estimate))) %>% 
   ggplot() +
        geom_point(aes(x = exp(estimate), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Ambulatory \n neg bin - with year term, no bootstrap") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))


#patchwork
(a1 + a2 + a3) / (a4 + a5 + a6)

ggsave("amb_sens.png", width = 10, height = 6)
```



```{r}

r1 <-
rme_boot_2yr_block %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events \n 2 year block") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

r2 <-
rme_boot_2yr_block %>% 
    unnest(tidy_bca) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events \n 2 year block - Bca CIs") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

r3 <-
rme_boot_3yr_block %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events \n 3 year block") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))


r4 <-
rme_boot_std %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events \n standard bootstrap") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

r5 <-
rme_nb %>% 
    unnest(nb_tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(estimate))) %>% 
   ggplot() +
        geom_point(aes(x = exp(estimate), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events \n neg bin - no year term, no bootstrap") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

r6 <-
rme_nb %>% 
    unnest(nb_year_tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(estimate))) %>% 
   ggplot() +
        geom_point(aes(x = exp(estimate), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events \n neg bin - with year term, no bootstrap") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))


#patchwork
(r1 + r2 + r3) / (r4 + r5 + r6)

# ggsave("rme_sens.png", width = 10, height = 6)
```

  mutate(value = case_when(str_detect(index, "hour")  ~ value * 24,
                        TRUE ~ value)) %>% 


